name: CI/CD Stage

on:
  push:
    branches:
      - stage
    paths:
      - 'be-core/**'
      - 'worker/**'

jobs:
  deploy:
    runs-on: [self-hosted, stage]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # âœ… Selalu tulis .env dulu supaya selalu ada di local
      - name: ğŸ“„ Write be-core .env
        run: echo "${{ secrets.BE_CORE_STAGE_ENV }}" > ./be-core/.env

      - name: ğŸ“„ Write worker .env
        run: echo "${{ secrets.WORKER_STAGE_ENV }}" > ./worker/.env

      # ğŸ§  Detect changes: bandingkan commit HEAD^ dan HEAD
      - name: ğŸ” Detect changes
        id: changes
        run: |
          echo "BE_CORE_CHANGED=$(git diff --name-only HEAD^ HEAD | grep '^be-core/' || true)" >> $GITHUB_ENV
          echo "WORKER_CHANGED=$(git diff --name-only HEAD^ HEAD | grep '^worker/' || true)" >> $GITHUB_ENV

      # ğŸ—‘ Remove old be-core image jika ada perubahan
      - name: ğŸ—‘ Remove old be-core image
        if: env.BE_CORE_CHANGED != ''
        run: docker rmi be-core-stage:latest || true

      # ğŸ›  Build new be-core image
      - name: ğŸ›  Build new be-core image
        if: env.BE_CORE_CHANGED != ''
        run: docker build -t be-core-stage:latest ./be-core

      # ğŸ—‘ Remove old worker image jika ada perubahan
      - name: ğŸ—‘ Remove old worker image
        if: env.WORKER_CHANGED != ''
        run: docker rmi worker-stage:latest || true

      # ğŸ›  Build new worker image
      - name: ğŸ›  Build new worker image
        if: env.WORKER_CHANGED != ''
        run: docker build -t worker-stage:latest ./worker

      # ğŸ³ Refresh containers: down â†’ up -d
      - name: ğŸš€ Deploy using docker-compose
        run: |
          docker compose -f docker-compose.stage.yml down
          docker compose -f docker-compose.stage.yml up -d
